<script setup >

import {useUserStore} from "@/stores/user.js";
import {ref, useTemplateRef} from "vue";
import api from "@/js/http/api.js";
import UpdateIcon from "@/components/navbar/icons/UpdateIcon.vue";
import RemoveIcon from "@/components/navbar/icons/RemoveIcon.vue";
import {useRouter} from "vue-router";
import ChatField from "@/components/character/chat_field/ChatField.vue";


const props = defineProps(['character','canEdit'])
const emit=defineEmits(['remove'])
const isHover = ref(false)
const user=useUserStore()
const router=useRouter()

async function handleRemoveCharacter(){
  try{
    const res = await api.post('api/create/character/remove/',{
      character_id:props.character.id
    })
    if (res.data.result === 'success'){
      emit('remove',props.character.id)
    }
  }catch (err){
    console.log(err)
  }
}
const chatFieldRef=useTemplateRef('chat-field-ref')
const friend = ref(null)
async function openChatField(){
  if (!user.isLogin()){
    await router.push({
      name:'user-account-login-index'
    })
  }else {
    try{
      const res=await api.post('api/friend/get_or_create/',{
        character_id : props.character.id,
      })
      const data =res.data
      if (data.result === 'success'){
        friend.value =data.friend
        chatFieldRef.value.showModal()
      }
    }catch (err){
      console.log(err)
    }
  }
}
</script>

<template>
 <div>
    <div class="avatar cursor-pointer" @mouseover="isHover=true" @mouseout="isHover=false" @click="openChatField">
      <div class="w-60 h-100 rounded-2xl relative">
        <img :src="character.background_image" class="transition-transform duration-300" :class="{'scale-120': isHover}" alt="">
        <div class="absolute left-0 top-50 w-60 h-50 bg-linear-to-t from-black/40 to-transparent"></div>

        <div v-if="canEdit && character.author.user_id === user.id" class="absolute right-0 top-50">
          <RouterLink :to="{name: 'update-character', params: {character_id: character.id}}" class="btn btn-circle btn-ghost bg-transparent">
            <UpdateIcon />
          </RouterLink>
          <button @click="handleRemoveCharacter" class="btn btn-circle btn-ghost bg-transparent">
            <RemoveIcon />
          </button>
        </div>

        <div class="absolute left-4 top-54 avatar">
          <div class="w-16 rounded-full ring-3 ring-white">
            <img :src="character.photo" alt="">
          </div>
        </div>
        <div class="absolute left-24 right-4 top-58 text-white font-bold line-clamp-1 break-all">
          {{ character.name }}
        </div>
        <div class="absolute left-4 right-4 top-72 text-white line-clamp-4 break-all">
          {{ character.profile }}
        </div>
      </div>
    </div>
    <RouterLink :to="{name: 'user-space-index', params: {user_id: character.author.user_id}}" class="flex items-center mt-4 gap-2 w-60">
      <div class="avatar">
        <div class="w-7 rounded-full">
          <img :src="character.author.photo" alt="">
        </div>
      </div>
      <div class="text-sm line-clamp-1 break-all">{{ character.author.username }}</div>
    </RouterLink>
    <!--   :friend="friend" 是 Vue 中动态属性绑定的语法，用于将父组件的数据传递给子组件-->
    <!--  : ：v-bind: 的缩写，表示动态绑定   friend ：子组件接收的 prop 名称  "friend" ：父组件中的数据变量 -->
    <ChatField ref="chat-field-ref" :friend="friend"/>
  </div>


</template>

<style scoped>

</style>